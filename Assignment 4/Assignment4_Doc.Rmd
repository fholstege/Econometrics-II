---
title: "Assignment 4 - Econometrics II"
author: Floris Holstege, Stanislav Avdeev
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Packes required for subsequent analysis. P_load ensures these will be installed and loaded. 
if (!require("pacman")) install.packages("pacman")
pacman::p_load(plm, 
               Formula,
               car,
               clubSandwich,
               lmtest,
               foreign,
               tidyverse,
               xtable,
               stargazer,
               AER)

```

```{r, echo=FALSE}

# dataframe with the percentages per case/arrest and judge
dfJudge <- data.frame( cases = c(0.7, 0.3, 0.4, 0.6), arrests = c(0.4, 0.6, 0.2, 0.5) )
rownames(dfJudge) <- c("Jones-Prison", "Jones-Other", "Smith-Prison", "Smith-Other")

PY_1_Z_1 = sum(dfJudge$perc_arrest_cond[c(1,2)])
PY_1_Z_0 = sum(dfJudge$perc_arrest_cond[c(3,4)])
PD_1_Z_1 = dfJudge$perc_sentence[1]
PD_1_Z_0 = dfJudge$perc_sentence[3]



wald_est <- (PY_1_Z_1 - PY_1_Z_0)/ (PD_1_Z_1 - PD_1_Z_0)
wald_est



```

## Problem 1


We use the allocation to the two judges as a instrument. This instrument is relevant, since one judge (Jones) will sentence more than the other (Smith). But it is also exogenous, since the defendants are randomly allocated to a judge. 

In order to assess the effect of a prison sentence of future arrests, we use the Wald-estimator, defined as follows:

\begin{align*}
\beta_{wald} = \frac{P(Y = 1 | Z = 1) - P(Y = 1 | Z = 0)}{P(D = 1 | Z = 1) = P(D = 1 | Z = 0 )}
\end{align*}

Where $P(Y = 1)$ is the probability of an arrest in the subsequent 3 years, $Z$ is our instrumental variable, with $Z = 1$ being judged by Jones, and $Z = 0$ being judged by Smith. $P(D = 1)$ is the probability of an prison sentence. 

To estimate the probabilities, we simply use the \% of each event occuring in our sample. The Wald estimator then becomes: 

\begin{align*}
\beta_{wald} =  \frac{0.46 - 0.38}{0.7 - 0.4} = \frac{0.08}{0.3} = 26 \frac{2/3}\%
\end{align*}

This implies that if one receives a prison sentence, one is  $26 \frac{2/3}\%$ more likely to be arrested in the subsequent 3 years. This effect holds for all compliers, e.g. those who underwent the treatment. In this case, if the prison sentence is strongly enforced (e.g. nobody is able to escape), then presumably the effect holds for the whole population, since all are complying. 

The definition of always takers is more formally: 
\begin{align*}
  D(1) = D(0) = 1
\end{align*}

Which in this case means always takers are those who would undergo a prison sentence (D(1)), even if the judge did not convict them (D(0)). 



```{r}


# get size, given mde 
get_size_givenMDE <- function(MDE, fAlpha, fPower, p, Sigma2){
  
  # get t values
  t_alpha <- qnorm(1-fAlpha/2, 0,Sigma2)
  t_q <-qnorm(1-fPower, 0,Sigma2)
  
  # get the MDE
  size <- (((t_alpha - t_q)/MDE)^2) * sigma2/(p*(1-p))
  size <- round(size, 0)
  
  return(size)
}
  
# get parameters for power calculation
MDE = 0.1
fAlpha = 0.05
fPower = 0.7
p = 0.5
sigma2 <- p* (1- p)

# determine size 
size = get_size_givenMDE(MDE, fAlpha, fPower, p, sigma2)

# define percentage that does not comply
perc_nonComply <- 0.2

# new size, given rate of non-compliance
new_size = (1/(1-perc_nonComply))*size


```


```{r}

# get data on flu shots, divide in treatment and control
dfFlu <- read.dta13("Data/FluData.dta")
dfFlu_treatment <- dfFlu[dfFlu$TreatGroup == 1,]
dfFlu_control <- dfFlu[dfFlu$TreatGroup == 0,]

# percentage that got the flu in the treatment group (got flu shot)
p_flu <- sum(dfFlu_treatment$Flu)/nrow(dfFlu_treatment)
# estimate the sigma2
sigma2_flu <- p*(1-p)

# size of the experiment, given p and sigma2
size_flu <- get_size_givenMDE(0.05, fAlpha, fPower, p_flu, sigma2_flu)

# get df with group that actually got the treatment
dfFlu_actualTreatment <- dfFlu_treatment[dfFlu_treatment$Treatment == 1,]
perc_comply_flu <- nrow(dfFlu_actualTreatment)/nrow(dfFlu_treatment)

# get new size given the rate that did not get treatment
new_size_flu = (1/(perc_comply_flu)^2)*size_flu

```


```{r}

type_group <- ifelse(dfFlu$TreatGroup ==1 & dfFlu$Treatment == 0, "Untreated treatment",ifelse(dfFlu$TreatGroup ==1 & dfFlu$Treatment == 1, "Treated treatment","control"))
dfFlu$type_group <- type_group

dfSummary <- dfFlu %>%
  group_by(type_group) %>% 
  summarise(perc_boy = sum(GenderChild)/n(),
            mean_age_mother = mean(AgeMother),
            mean_edu_mother = mean(EducationMother),
            perc_married = sum(Married)/n(),
            perc_nationality = sum(Nationality)/n(),
            mean_HHincome = mean(Hhincome)
            )
    

```


```{r}

# define the two models
model_ols_simple <- lm(Flu ~ Treatment, data=dfFlu_treatment)
model_ols_extensive <- lm(Flu ~ Treatment + GenderChild + AgeMother + EducationMother + Married + Nationality + Hhincome, data = dfFlu_treatment)

# check the output
summary(model_ols_simple)
summary(model_ols_extensive)

calc_robust_se <- function(model){
  
  cov_model <- vcovHC(model, type = "HC1")
  robust_se <- sqrt(diag(cov_model))
  return(robust_se)
}


# Adjust standard errors
robust_se_simple    <- calc_robust_se(model_ols_simple)
robust_se_extensive <- calc_robust_se(model_ols_extensive)
  
# create stargazer output
stargazer(model_ols_simple, model_ols_extensive, se = list(robust_se_simple, robust_se_extensive))

```

```{R}


# run both 2sls regressions - simple and extensive model
model_ols_simple_iv <- ivreg(Flu ~ Treatment | TreatGroup, data=dfFlu)
model_ols_extensive_iv <- ivreg(Flu ~ Treatment + GenderChild + AgeMother + EducationMother + Married + Nationality + Hhincome
                                | TreatGroup + GenderChild + AgeMother + EducationMother + Married + Nationality + Hhincome, data=dfFlu)

summary(model_ols_simple_iv)
summary(model_ols_extensive_iv)


# Adjust standard errors
robust_se_simple_iv    <-  calc_robust_se(model_ols_simple_iv)
robust_se_extensive_iv <-  calc_robust_se(model_ols_extensive_iv)

# create stargazer output
stargazer(model_ols_simple_iv, model_ols_extensive_iv, se = list(robust_se_simple_iv, robust_se_extensive_iv))



```

```{R}

# run partial regression
## not affraid of irrelevant instrument, since 67% overlap...
Partial_ols_FluShot <- lm(Treatment ~ TreatGroup, data=dfFlu)
summary(Partial_ols_FluShot)

```
