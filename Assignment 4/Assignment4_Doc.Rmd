---
title: "Assignment 4 - Econometrics II"
author: Floris Holstege, Stanislav Avdeev
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Packes required for subsequent analysis. P_load ensures these will be installed and loaded. 
if (!require("pacman")) install.packages("pacman")
pacman::p_load(plm, 
               Formula,
               car,
               clubSandwich,
               lmtest,
               foreign,
               tidyverse,
               xtable,
               stargazer,
               AER,
<<<<<<< HEAD
               rio)
=======
               readstata13)
>>>>>>> 5d86b146a047c03552c88a06609e5cee7bc5e75a

```

```{r, echo=FALSE}

# dataframe with the percentages per case/arrest and judge
dfJudge <- data.frame( perc_sentence = c(0.7, 0.3, 0.4, 0.6), perc_arrest = c(0.4, 0.6, 0.2, 0.5) )
rownames(dfJudge) <- c("Jones-Prison", "Jones-Other", "Smith-Prison", "Smith-Other")

dfJudge$perc_arrest_cond = dfJudge$perc_sentence * dfJudge$perc_arrest



PY_1_Z_1 = sum(dfJudge$perc_arrest_cond[c(1,2)])
PY_1_Z_0 = sum(dfJudge$perc_arrest_cond[c(3,4)])
PD_1_Z_1 = dfJudge$perc_sentence[1]
PD_1_Z_0 = dfJudge$perc_sentence[3]


wald_est <- (PY_1_Z_1 - PY_1_Z_0)/ (PD_1_Z_1 - PD_1_Z_0)
wald_est



```

## Problem 1


We use the allocation to the two judges as a instrument. This instrument is relevant, since one judge (Jones) will sentence more than the other (Smith). But it is also exogenous, since the defendants are randomly allocated to a judge. 

I) In order to assess the effect of a prison sentence of future arrests, we use the Wald-estimator, defined as follows:

\begin{align*}
\beta_{wald} = \frac{P(Y = 1 | Z = 1) - P(Y = 1 | Z = 0)}{P(D = 1 | Z = 1) = P(D = 1 | Z = 0 )}
\end{align*}

Where $P(Y = 1)$ is the probability of an arrest in the subsequent 3 years, $Z$ is our instrumental variable, with $Z = 1$ being judged by Jones, and $Z = 0$ being judged by Smith. $P(D = 1)$ is the probability of an prison sentence. 

To estimate the probabilities, we simply use the \% of each event occuring in our sample. The Wald estimator then becomes: 

\begin{align*}
\beta_{wald} =  \frac{0.46 - 0.38}{0.7 - 0.4} = \frac{0.08}{0.3} = 0.26 \frac{2}{3}
\end{align*}

II) The result implies that if one receives a prison sentence, one is  $26 \frac{2}{3}\%$ more likely to be arrested in the subsequent 3 years. This effect holds for all compliers. 

Since we are working with an instrument, the definition of compliers and always takers changes. Instead of related to the prison treatment, it is not related to the instrument that we use to estimate the actual effect. That is because non-compliance is now only relevant insofar as it effects the observed outcome from this instrument. The definition here is therefore:

\begin{align*}
  Z(1) = 1, Z(0) = 0
\end{align*}

In this case, those are people who under Jones went to prison, but would not under smith, and those that under Smith would go to prison, but not under Jones. $(0.7 \cdot 0.6) + (0.4 \cdot 0.3) = 0.54$.

III) The definition of always takers is in this case

\begin{align*}
  Z(1) = Z(0) = 1
\end{align*}

More specifically, an always taker is someone who is sent to prison by both judges. This fraction equals $0.7 \cdot 0.4 = 0.28$.


```{r}


get_size_givenMDE <- function(MDE, t_Alpha, t_Power, p, Sigma2){
  
  # get the MDE
  size <- (((t_Alpha - t_Power)/MDE)^2) * sigma2/(p*(1-p))
  size <- round(size, 0)
  
  return(size)
}
  

MDE = 0.1
t_Alpha = 1.96
t_Power = -0.524
p = 0.5
sigma2 <- p* (1- p)

size <- get_size_givenMDE(0.1, t_Alpha, t_Power, p, sigma2)
size

perc_nonComply <- 0.2

new_size = (1/(1-perc_nonComply)^2)*size
new_size



```

## Problem 2

I) We use the following formula:
\begin{align*}
n = (\frac{(1.96 + 0.524)}{MDE})^2 * \frac{\sigma^2}{p \cdot(1-p)} = 617
\end{align*}
Where n is the required sample size, $\sigma^2$ is the variance, and $p$ is the proportion of the control group in the experiment. 


II) The sample size has to increase in order to make up for the non-compliance. We calculate this as follows:

\begin{align*}
\text{new n} = n \cdot \frac{1}{0.8^2} = 965
\end{align*}




```{r}

# get data on flu shots, divide in treatment and control
dfFlu <- import("FluData.dta")
dfFlu_treatment <- dfFlu[dfFlu$TreatGroup == 1,]
dfFlu_control <- dfFlu[dfFlu$TreatGroup == 0,]

# percentage that got the flu in the treatment group (got flu shot)
p_flu <- 0.8
sigma2_flu <- p_flu*(1-p_flu)

t_Alpha_flu = 1.96
t_Power_flu = -0.84

# size of the experiment, given p and sigma2
size_flu <- get_size_givenMDE(0.05, t_Alpha_flu, t_Power_flu, p_flu, sigma2_flu)
size_flu

# get df with group that actually got the treatment
dfFlu_actualTreatment <- dfFlu_treatment[dfFlu_treatment$Treatment == 1,]
perc_comply_flu <- nrow(dfFlu_actualTreatment)/nrow(dfFlu_treatment)

# get new size given the rate that did not get treatment
new_size_flu = (1/(perc_comply_flu)^2)*size_flu
new_size_flu

```


```{r}

type_group <- ifelse(dfFlu$TreatGroup ==1 & dfFlu$Treatment == 0, "Untreated treatment",ifelse(dfFlu$TreatGroup ==1 & dfFlu$Treatment == 1, "Treated treatment","control"))
dfFlu$type_group <- type_group

dfSummary <- dfFlu %>%
  group_by(type_group) %>% 
  summarise(perc_boy = sum(GenderChild)/n(),
            mean_age_mother = mean(AgeMother),
            mean_edu_mother = mean(EducationMother),
            perc_married = sum(Married)/n(),
            perc_nationality = sum(Nationality)/n(),
            mean_HHincome = mean(Hhincome),
            perc_group = n()/nrow(dfFlu)
            )

xtable(dfSummary)
    

```


```{r}

# define the two models
model_ols_simple <- lm(Flu ~ Treatment, data=dfFlu_treatment)
model_ols_extensive <- lm(Flu ~ Treatment + GenderChild + AgeMother + EducationMother + Married + Nationality + Hhincome, data = dfFlu_treatment)

# check the output
summary(model_ols_simple)
summary(model_ols_extensive)

calc_robust_se <- function(model){
  
  cov_model <- vcovHC(model, type = "HC1")
  robust_se <- sqrt(diag(cov_model))
  return(robust_se)
}


# Adjust standard errors
robust_se_simple    <- calc_robust_se(model_ols_simple)
robust_se_extensive <- calc_robust_se(model_ols_extensive)
  
# create stargazer output
stargazer(model_ols_simple, model_ols_extensive, se = list(robust_se_simple, robust_se_extensive))

```

```{R}


# run both 2sls regressions - simple and extensive model
model_ols_simple_iv <- ivreg(Flu ~ Treatment | TreatGroup, data=dfFlu)
model_ols_extensive_iv <- ivreg(Flu ~ Treatment + GenderChild + AgeMother + EducationMother + Married + Nationality + Hhincome
                                | TreatGroup + GenderChild + AgeMother + EducationMother + Married + Nationality + Hhincome, data=dfFlu)

summary(model_ols_simple_iv)
summary(model_ols_extensive_iv)


# Adjust standard errors
robust_se_simple_iv    <-  calc_robust_se(model_ols_simple_iv)
robust_se_extensive_iv <-  calc_robust_se(model_ols_extensive_iv)

# create stargazer output
stargazer(model_ols_simple_iv, model_ols_extensive_iv, se = list(robust_se_simple_iv, robust_se_extensive_iv))



```

```{R}

# run partial regression
## not affraid of irrelevant instrument, since 67% overlap...
Partial_ols_FluShot <- lm(Treatment ~ TreatGroup, data=dfFlu)
summary(Partial_ols_FluShot)

```

VII)
 
We assume two things; first, there are no always takers, e.g. people who took the vaccine if they were not assigned to the treatment group. Second, we don't have defiers in our sample when estimating the LATE, e.g. the people who were assigned the treatment but did not comply. We then are left with compliers and never takers (e.g. those who would have not taken the vaccine irrespective of the assigned group).\\
\\
We define $p_{1c}$ as the percentage of compliers in the treatment group, and $p_{0c}$ the percentage  of compliers in the control group.

We define $Y_{i, c}$ as the dependent variable for compliers, and $Y_{i, nt}$ for the never takers. \\

\begin{align*}
    \E[Y | Z = 1] = p_{1,c} \cdot Y_{1,c} + (1-p_{1,c}) \cdot Y_{1, nt}\\
    \E[Y | Z = 0] = p_{0,c} \cdot Y_{0,c} + (1-p_{0,c}) \cdot Y_{0, nt}
\end{align*}

In order to find the LATE, we define the Wald estimator is defined as:

\begin{align*}
\delta_{Wald} &= \frac{ \E[Y | Z = 1] -  \E[Y | Z = 0]}{\E[D| Z=1]−\E[D| Z=0} \\
&= \frac{p_{1c} \cdot Y_{1,c} + (1-p_{1,c}) \cdot Y_{1, nt} -  p_{0,c} \cdot Y_{0,c} + (1-p_{0,c}) \cdot Y_{0, nt}}{\E[D| Z=1] − \E[D| Z=0}
\end{align*}


 We assume $p_{1c} = p_{0c} = p_c$, e.g. the proportion of people who comply in the treatment group is similar to the control group - this is strong assumption in this case, since it seems more plausible that people would divert from the receiving vaccination (due to beliefs about the possible side effects) than the control. We can rewrite the wald estimator as: 
 
 
 \begin{align*}
 \delta_{Wald} = \frac{p\cdot ( Y_{1,c} - Y_{0,c}) + (1-p) \cdot (Y_{1, nt} - Y_{0, nt})}{\E[D| Z=1] − \E[D| Z=0}
 \end{align*}
 
$\E[D| Z=1] = p_{1,c} = p $, since its just the percentage of people that undertake take the treatment compliers. $\E[D| Z=0] =0 $, since there are no people who undertake the treatment who were not assigned (e.g. no always takers). We can thus rewrite the wald estimator as: 


\begin{align*}
    \delta_{Wald} &= \frac{p\cdot ( Y_{1,c} - Y_{0,c}) + (1-p) \cdot (Y_{1, nt} - Y_{0, nt})}{p}\\
    &= Y_{1,c} - Y_{0,c} = ATET
\end{align*}

where the $ATET$ is the of the average treatment effect on the treated, because we assume once treated everyone complies. 
